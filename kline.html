<!DOCTYPE html>
<html style="height:100%;" >
    <head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />

 <link href="http://klang.zhanluejia.net.cn/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
     <!-- font awesome CSS -->
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
      <!-- Vendor CSS Files -->
   <style>
    .stock-chart {
        width: 100%;
        height: 100%;
        position: relative
    }

    .k-line-chart-dark {
        position: relative;
        height: 100%;
        background-color: #1e2126;
        transition: all .5s
    }

    .top-bar {
        font-size: 14px;
        height: 38px;
        color: #929aa5;
        border-bottom: 1px solid #393a3e;
        padding: 0 20px 0 12px
    }
    .tools {
        width: 48px;
        height: 100%;
        border-right: 1px solid #393a3e
    }
    .chart-widget {
        width: calc(100% - 48px);
        height: 100%;
        position: relative
    }

    .k-line-chart-light {
        position: relative;
        height: 100%;
        width: 80%;
        min-height:600px;
        margin:10px;
        background-color: #fff;
        transition: all .5s
    }

    .k-line-chart-container {
        height: calc(100% - 38px)
    }
    .bg {
        background: rgba(14, 22, 34, 0.02);
    }


   .boardmain {
        display: -webkit-box;
        display: -webkit-flex;
        display: flex;
        -webkit-box-orient: vertical;
        -webkit-flex-direction: column;
        flex-direction: column;
        -webkit-box-align: start;
        -webkit-align-items: flex-start;
        align-items: flex-start;
    }   

    .boardmain > div.three{
        -webkit-box-ordinal-group: 3;
        -moz-box-ordinal-group: 3;
        -ms-flex-order: 3;
        -webkit-order: 3;
        order: 3;
        overflow:visible;
    } 

    .boardmain > div.two{
        -webkit-box-ordinal-group: 2;
        -moz-box-ordinal-group: 2;
        -ms-flex-order: 2;
        -webkit-order: 2;
        order: 2;
        overflow:visible;
    }

    .boardmain > div.one{
        -webkit-box-ordinal-group: 1;
        -moz-box-ordinal-group: 1;
        -ms-flex-order: 1;
        -webkit-order: 1;
        order: 1;
    }   




   </style>

  <!-- Template Main CSS File -->
  <!--link href="http://klang.zhanluejia.net.cn/assets/css/style.css" rel="stylesheet"-->


        <title>Klang(金浪)自选股票</title>

    </head>
    <body class="bg" style="height: 100%;min-height:600px;">
     <div id="app" style="height:100%;">
      <div class="boardmain col-10" style="height:100%;">
      <div v-bind:class="'k-line-chart-light shadow-sm p-3 mb-5 bg-white rounded ' + lineorder">
          <div class="top-bar"> 
            <span v-if="stocklist.length" style="margin-right:10px;">{{stocklist[0]}}</span>
            <i class="fa fa-sort-amount-down" v-if="lineorder=='one'" @click="linedown"></i>
            <i class="fa fa-sort-amount-up" v-if="lineorder=='three'" @click="lineup"></i>

          </div>

          <div class="row stock-chart k-line-chart-container"> 
              <div class="col tools"> </div>

              <div class="chart-widget">
                <div id="klinelinemain" style="width:100%;height:100%;"> </div>
              </div>
          </div>

      </div> <!-- k-line-chart-light -->

      <div class="k-line-chart-light shadow-sm p-3 mb-5 bg-white rounded two">
          <div class="top-bar"> 
            <span v-if="stocklist.length" style="margin-right:10px;">{{stocklist[0]}}</span>
          </div>

          <div class="row stock-chart k-line-chart-container"> 
              <div class="col tools"> </div>

              <div class="chart-widget">
                <div id="klinedaymain" style="width:100%;height:100%;"> </div>
              </div>
          </div>

      </div> <!-- k-line-chart-light -->
      </div> <!-- boardmain -->
 
 
      <div class="shadow-sm p-3 mb-5 bg-white rounded col-3" style="z-index:9999;position:fixed; right: 10px; top: 10px; margin:10px;">
            <h3>最近访问</h3>
            <table class="table table-bordered" border="1">
            <thead>
            <tr>
            <th scope="col">name</th>
            <th scope="col">code</th>
            <th scope="col">值
           <a @click="openopt()">

            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-bar-right" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M6 8a.5.5 0 0 0 .5.5h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L12.293 7.5H6.5A.5.5 0 0 0 6 8zm-2.5 7a.5.5 0 0 1-.5-.5v-13a.5.5 0 0 1 1 0v13a.5.5 0 0 1-.5.5z"/>
            </svg>
            </a> </th>
            <th scope="col" v-if="opened">操作</th>
            </tr>
            </thead>
             <tbody>
                <tr v-for="(item,index) in stocklist">
                <td v-if="result[item]"><a @click="reload(item)" target=_blank>{{result[item][0]}}</a></td>
                <td v-if="result[item]"><a v-bind:href="'https://gu.qq.com/'+item" target=_blank ><font color=blue>{{result[item][1]}}</font></a></td>
                <td v-if="result[item]"><font v-if="result[item][2]>=0" color="#ef4136">+{{result[item][2]}}</font> <font v-if="result[item][2]<0" color="#00ef00">{{result[item][2]}}</font></td>
                <td v-if="opened">
                   <a @click="delmain(item)" class="text-decoration-none"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-x" viewBox="0 0 16 16">
  <path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H1s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C9.516 10.68 8.289 10 6 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
  <path fill-rule="evenodd" d="M12.146 5.146a.5.5 0 0 1 .708 0L14 6.293l1.146-1.147a.5.5 0 0 1 .708.708L14.707 7l1.147 1.146a.5.5 0 0 1-.708.708L14 7.707l-1.146 1.147a.5.5 0 0 1-.708-.708L13.293 7l-1.147-1.146a.5.5 0 0 1 0-.708z"/>
</svg> </a>
                </td>
                </tr>
                </tbody>
            </table>

      </div>

<div style="z-index: 9999; position:fixed; right: 50px; bottom: 50px;">
<button class="btn btn-primary" @click="refresh">刷</button>
</div>

   </div> <!-- app -->
    
    <script src="http://www.zhanluejia.net.cn/corlate/js/jquery.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.1.0/vue.global.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.21.1/axios.min.js"></script>

  <!-- Template Main JS File -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/klinecharts@8.0.0-alpha4/dist/klinecharts.min.js"></script>
      <script>
       function getUrlParam(name){

            var reg=new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r= window.location.search.substr(1).match(reg);

            if(r != null) {
                return unescape(r[2]);
            }
            return null;
     }
 

       var hostname = window.location.hostname
       var host = window.location.host
       if (hostname == ""){
            hostname = "127.0.0.1"
            apihost = "http://127.0.0.1:9999"
       } else {
            apihost = "http://api.klang.org.cn"+
       }



       function getbrowserlist(){
         var blist=[]
         blist1 = localStorage.getItem("klangbrowserlist")

         if (blist1 != null){
            blist = JSON.parse(blist1)
         }
            
         return blist

       }

     function savebrowserlist(code1){
         var blist=[]
         blist1 = localStorage.getItem("klangbrowserlist")

         if (blist1 != null){
            blist = JSON.parse(blist1)
         }
        i = blist.indexOf(code1) 
        
        if(i >= 0){
            //更换顺序
            blist.splice(i,1)
        }    
        //添加到开头
        blist.unshift(code1)
        localStorage.setItem("klangbrowserlist",JSON.stringify(blist))
        return blist
    }


    function deletebrowserlist(code){
         var blist=[]
         blist1 = localStorage.getItem("klangbrowserlist")

         if (blist1 != null){
            blist = JSON.parse(blist1)
         }
        
        i = blist.indexOf(code) 
        if (i>0){
            blist.splice(i,1)
        }
        localStorage.setItem("klangbrowserlist",JSON.stringify(blist))
        return blist
 
    }






          function formatData(code,datas){
            var name = datas[0]
            var close1 = datas[2]
            var close = datas[3]

            var rise = 100 * (close - close1) / close1
            if (String(parseFloat(rise)) != "NaN"){ //NaN 是无法直接比较的
                rise = parseFloat(rise).toFixed(2)
            } else {
                rise = 0.000
            } 
            close = parseFloat(close).toFixed(2) 
            vue.$data.result[code]=[name,close,rise]
            console.log(name,close,rise)
       }
       

      async function getDatas(that){
        stocklist = that.stocklist
        for (i=0 ; i < stocklist.length;i+=100){
            params = stocklist.slice(i,i+100).join()
            response = await axios.get(apihost+"/?list="+params)

            var hq_str_sys_auth;
 
            eval(response.data)

            // 服务器返回错误，上面的定义就会在eval时候被赋值
            if (hq_str_sys_auth=="FAILED"){
                return
            }
            console.log(response)
        }
        stocklist.forEach(function(item){

                  eval('window.'+item +'= hq_str_'+item)
                  var datas= window[item].split(',')

                  formatData(item,datas)

                })

      }





    var datalinelist = []
    var datadaylist = []
    var linebar = 255
    var code = getUrlParam('code')
    if (code == null ){
        //中国电建
        code = 'sh601669'
    }

    async function getLineSinaData(code){
        var close1 = ''
        response = await axios.get(apihost+'/cn/api/json_v2.php/CN_MarketDataService.getKLineData?symbol='+code+'&scale=1&ma=no&datalen='+linebar)

        //
        data = response.data
        var lastday = new Date(data[data.length-1].day).toDateString()

        response.data.forEach(function(item){
            if (item.day.search('15:00:00') > 0 && close1==''){
                close1 = item.close
            }
            //如果实时数据是今天，则显示
            if(new Date(item.day).toDateString() === lastday){
                datalinelist.push({
                    open: parseFloat(item.open),
                    close: parseFloat(item.close),
                    high: parseFloat(item.high),
                    low: parseFloat(item.low),
                    volume: parseFloat(item.volume),
                    timestamp:new Date(item.day).getTime(),
                })
            }
        })
        return close1
    }


    async function getDaySinaData(code){
        var lastday1
        //日K数据结构不包含正在交易的日K数据
        response = await axios.get(apihost+'/cn/api/json_v2.php/CN_MarketDataService.getKLineData?symbol='+code+'&scale=240&ma=no&datalen=280')
        response.data.forEach(function(item){

                datadaylist.push({
                    open: parseFloat(item.open),
                    close: parseFloat(item.close),
                    high: parseFloat(item.high),
                    low: parseFloat(item.low),
                    volume: parseFloat(item.volume),
                    timestamp:new Date(item.day).getTime(),
                })
            lastday1 = item
        })
        
        //用实时数据补齐当日的日K
        response1 = await axios.get(apihost+"/?list="+code)
        var lastday = response1.data.split(",")
        if (lastday.length>30){
            ldate = lastday[30]
            if(ldate !=lastday1.day){
                //如果不包含就补齐
                datadaylist.push({
                    open:parseFloat(lastday[1]),
                    close:parseFloat(lastday[3]),//当前日期的实施数据为当今收盘价
                    high:parseFloat(lastday[4]),
                    low:parseFloat(lastday[5]),
                    volume:parseFloat(lastday[8]),
                    timestamp:new Date(ldate).getTime(),
                })
                
            }
        } 
    }

 
    window.onload = async function () {


        const VueApp = {
             data() {
                return {
                lineorder:'one',
                chartline:'',
                chartday:'',
                reloadlock:0,
                result:[],
                stocklist:[],
            }
          },
          watch:{

            stocklist(){
                getDatas(this)
            },

          }, 
          created() {
                 var lineorder = localStorage.getItem("lineorder")
                 if (lineorder == 'one' || lineorder == 'three'){
                    this.lineorder = lineorder
                }
         },

         mounted () {
            var that = this
            getDatas(that)
         },
         methods: {
                linedown(){
                    this.lineorder="three"
                    localStorage.setItem("lineorder",this.lineorder)
                },
                lineup(){
                    this.lineorder="one"
                    localStorage.setItem("lineorder",this.lineorder)
                },
                async refresh(){
                    datadaylist = []
                    datalinelist = []
                    await getDaySinaData(code)
                    this.chartday.applyNewData(datadaylist)
 
                    //获取昨天的收盘价
                    close1 = await getLineSinaData(code)

                    chartline.createTag([
                    {
                        id: 'close1',
                        mark: 'close',
                        text: close1,
                        point: { value: close1 },
                        styles: {
                            line: { color: '#98cc12' },
                            mark: { backgroundColor: '#f0f' },
                            text: { backgroundColor: '#00f' }
                            }
                    }])


                    barsize = this.chartline._chartPane._chartData._timeScaleStore._dataSpace 
                    // 靠左显示
                    this.chartline.setOffsetRightSpace((linebar-datalinelist.length) * barsize)

                    this.chartline.applyNewData(datalinelist)
 
                    getDatas(this)
                } ,//refresh
                async reload(newcode){
                    if (this.reloadlock == 1){
                        return
                    }
                    this.reloadlock = 1
                    code = newcode
                    this.stocklist = savebrowserlist(code)
                    await this.refresh()
                    this.reloadlock = 0
                }   
         } //methods
        }

        window.vue = Vue.createApp(VueApp).mount('#app')


        var chartline = klinecharts.init('klinelinemain')

        //chart.createTechnicalIndicator('MA', false, { id: 'candle_pane' })
        // 创建一个副图技术指标VOL
        chartline.createTechnicalIndicator('VOL')
        // 创建一个副图技术指标MACD
        //chart.createTechnicalIndicator('MACD')


        window.chartline = chartline
        
       chartline.setStyleOptions({
        candle: {
          type:'area',
          bar: {
           downColor: '#26A69A',
           upColor: '#EF5350',
           noChangeColor: '#888888'
          }
         },
        technicalIndicator: {
           bar: {
           downColor: '#26A69A',
           upColor: '#EF5350',
           noChangeColor: '#888888'
          }
        },
      })
        //获取昨天的收盘价
        close1 = await getLineSinaData(code)

       

         chartline.createTag([
          {
            id: 'close1',
            mark: 'close',
            text: close1,
            point: { value: close1 },
            styles: {
              line: { color: '#98cc12' },
              mark: { backgroundColor: '#f0f' },
              text: { backgroundColor: '#00f' }
            }
          }
         ])

        // linebar 每天的分时线个数 每分钟一个，245个
        barsize = chartline._chartPane._chartData._timeScaleStore._totalDataSpace / (linebar+10)
        // 每个的空间
        chartline._chartPane._chartData._timeScaleStore._dataSpace = barsize
        // 靠左显示
        chartline.setOffsetRightSpace((linebar-datalinelist.length) * barsize) 

        chartline.applyNewData(datalinelist)


        if (datalinelist.length>0){

            vue.$data.stocklist = savebrowserlist(code)
        }

        var chartday = klinecharts.init('klinedaymain')


        chartday.createTechnicalIndicator('MA', false, { id: 'candle_pane' })
        // 创建一个副图技术指标VOL
        chartday.createTechnicalIndicator('VOL')
        // 创建一个副图技术指标MACD
        chartday.createTechnicalIndicator('MACD')

        window.chartday = chartday

        window.vue.$data.chartday = chartday
        window.vue.$data.chartline = chartline

       chartday.setStyleOptions({
        candle: {
          bar: {
           downColor: '#26A69A',
           upColor: '#EF5350',
           noChangeColor: '#888888'
          }
         },
        technicalIndicator: {
           bar: {
           downColor: '#26A69A',
           upColor: '#EF5350',
           noChangeColor: '#888888'
          }
        },
      })
        await getDaySinaData(code)
        
        chartday.applyNewData(datadaylist)


    }
      
 
   </script>

    </body>
</html>
